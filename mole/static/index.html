<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <title>The Mole</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">

  <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
  This is the Mole Project. Have fun :D<br>
  <input id="create-button" type="button" value="Create Game"><br>
  <label id="token-label">Game Token:</label><br>
  <input id="start-button" type="button" value="Start Game"><br>
  <input id="join-player" type="button" value="Test Player Join"><br>

  <script>
    $(document).ready(function() {
      let socket = io.connect('');
      let token = '';
      let test_player_id = 0;
      let player_infos = null;

      $('#create-button').click(function() {
        socket.emit('create_game', '', function(data) {
          $('#token-label').text('Game Token: ' + data);
          token = data;
        })
      });

      $('#start-button').click(function() {
        socket.emit('start_game', token);
        console.log('game started');
      });

      $('#join-player').click(function() {
        if (token === '') {
          console.error('No game to join!');
          return;
        }

        let player_socket = io.connect('');
        let name = 'test_player' + test_player_id;
        let inventory = []

        player_socket.on('players_turn', data => {
          console.log(name + ' got players_turn. id: ', data)
        });

        player_socket.on('init', data => {
          console.log(name + ' got init:', data)
          if (data != null && data.clue != null) {
            inventory.push(data.clue)
          }
        data.players
        });

        player_socket.on('move', data => { console.log(name + ' got move. New position:', data) });
        player_socket.on('follower_move', data => { console.log(name + ' got follower move:', data) });
        player_socket.on('minigame', data => { console.log(name + ' got minigame:', data) });
        player_socket.on('validation_result', data => { console.log(name + ' got validation result:', data) });
        player_socket.on('updated_clue', data => { console.log(name + ' got updated clue:', data) });

        player_socket.on('receive_clue', data => {
          console.log(name + ' received clue:', data)
          if (data != null && data.clue != null) {
            inventory.push(data.clue)
          }
        });

        // occasion handling
        player_socket.on('occasion', data => {
          console.log(name + ' got occasion:', data)

          if (data != null && data.choices != null && data.choices.length > 0) {
            const index = Math.floor(Math.random() * data.choices.length)
            const occasion = data.choices[index]

            if (occasion.type === 'skip_player') {
              const player_ids = player_infos.map(pi => pi.player_id);
              const player_index = Math.floor(Math.random() * player_ids.length);
              occasion.player_id = player_ids[player_index]
            }
            if (occasion.type === 'found_clue') {
              occasion.success = Math.random() < 0.5
            }

            console.log('send occasion ', occasion);
            player_socket.emit('player_occasion_choice', occasion);
          }
        });

        player_socket.on('player_infos', data => {
          console.log(name + ' got player infos:', data);
          player_infos = data;
        });
        player_socket.on('gameover', data => { console.log(name + ' got player infos:', data) });

        player_socket.emit('join_game', {'token': token, 'name': 'test_player' + test_player_id});
        console.log('player "' + name + '" added');
        test_player_id += 1;

        // dice button
        const dice_button = $('<input type="button" value="Dice">');
        dice_button.click(function() {
          const value = Math.floor(Math.random() * 6) + 1
          player_socket.emit('player_choice', {'type': 'dice', 'value': value});
          console.log('diced a', value);
        })

        // player choice button
        const player_choice_button = $('<input type="button" value="Player Choice">');
        player_choice_button.click(function() {
          let index = Math.floor(Math.random() * 4)
          const player_choice_type = ['dice', 'share-clue', 'validate-clues', 'search-clue'][index]

          const message = {
            'type': player_choice_type
          }
          if (player_choice_type === 'dice') {
            message.value = Math.floor(Math.random() * 4) + 1;
          }
          if (player_choice_type === 'share-clue') {
            const player_ids = player_infos.map(pi => pi.player_id);
            const player_index = Math.floor(Math.random() * player_ids.length);
            message.with = player_ids[player_index]
            const inventory_index = Math.floor(Math.random() * inventory.length);
            message.clue = inventory[inventory_index].name
          }
          if (player_choice_type === 'validate-clues') {
             message.clues = inventory
          }
          if (player_choice_type === 'search-clue') {
             message.success = Math.random() < 0.5
          }

          console.log('send choice ', message);
          player_socket.emit('player_choice', message);
        })

        const body = $("body");
        body.append(dice_button)
        body.append(player_choice_button)
        body.append('<br>');
      })
    });
  </script>
</body>
</html>
